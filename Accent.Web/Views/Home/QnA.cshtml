@{
    ViewBag.Title = "QnA";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<style>
    .list-group-item {
    position: relative;
    display: block;
    padding: 16px 20px;
    margin-bottom: -1px;
    border: 1px solid #e6e6f2;
    text-align: justify;
}
    #ul-list-search .list-group-item a{
        color:#0056b3;
    }


    /*pagintation*/
    /*
Hi! If my code is useful for you can you donate me some money? 
https://www.paypal.me/melnik909
*/

/*
=====
LEVEL 0. RESET BROWSER'S STYLES
=====
*/

.pagination__list{
  padding-left: 0;
  margin-top: 0;
  margin-bottom: 0;
  list-style: none;  
}

/*
=====
LEVEL 1. CORE COMPONENT STYLES
=====
*/

.pagination{
  height:35px;
  font-size: 13px;
}

.pagination__list{
  display: flex;
  flex-wrap: wrap;
  align-items: center;
  justify-content: space-between;
}

.pagination__item:not(.pagination__control_prev):not(.pagination__item_active){
  padding-left: .5em;
}

.pagination__item:not(.pagination__control_next):not(.pagination__item_active){
  padding-right: .5em;
}

.pagination__item{
  display: inline-block;
  line-height: 1;
}

.pagination__control{
  position: relative;
}

.pagination__control:before, .pagination__control:after{
  font-size: 12px;
  line-height: 1;
  
  position: absolute;
  top: 50%;
  transform: translateY(-50%);
}

.pagination__control_prev{
  padding-left: calc(22px + 5px);
}

.pagination__control_prev:before{
  content: "←";
  left: 0;
}

.pagination__control_next{
  padding-right: calc(22px + 5px);
}

.pagination__control_next:after{
  content: "→";
  right: 0;
}

.pagination__item_active{
  padding: .5875em .8em;
  margin-right: .5em;
  margin-left: .5em;
}

</style>
<!-- ============================================================== -->
<!-- pageheader -->
<!-- ============================================================== -->
<div class="row">
    <div class="col-xl-12 col-lg-12 col-md-12 col-sm-12 col-12 pageheader-title p-t-20">
        <div class="d-flex">
            <h5 class="pageheader-title">myapplication phapluat-bot </h5>

            <div class="toolbar ml-auto p-r-10">
                <a href="#" class="btn btn-success btn-sm "><i class="fas fa-sync-alt"></i> Save and retrain</a>
                <a href="#" class="btn btn-primary btn-sm"><i class="fas fa-upload"></i> Publish</a>
            </div>
        </div>
        <div class="d-flex">
            <p style="font-size:13pt;padding-left:20px;color:darkblue;text-decoration:underline" id="search-label" for="search-terms"><i class="fas fa-search"></i> Test search</p>
            <div class="ml-auto" style="font-size:13px;padding-right:100px">Retrained 2 phút trước</div>
        </div>
    </div>
</div>
<div id="searchcontainer">
    <form id="search" action="#" method="post">
        <textarea type="text" name="search-terms" id="search-terms" placeholder="Tìm kiếm..."></textarea>

        <button type="button" class="btn btn-all" id="btnSearch">
            <i class="fa fa-search" aria-hidden="true"></i>
        </button>

        <a class="close-form-search"></a>
        <div id="div-suggest" jscontroller="tg8oTe" class="UUbT9" style="display:none;padding-left:10%;padding-right:10%" jsname="UUbT9" jsaction="h5M12e;mouseover:IgJl9c;mouseout:ItzDCd;mouseleave:MWfikb;YMFC3:VKssTb">
            <div class="RjPuVb" jsname="RjPuVb" style="display: none; width: 0px;"></div>
            <div class="aajZCb" jsname="aajZCb">
                <ul class="erkvQe" jsname="erkvQe" role="listbox" id="ul-suggest">

                </ul>
            </div>
        </div>
    </form>
    <div class="row">
        <div class="col-md-2"></div>
        <div class="col-md-8 col-sm-12 col-12" style="height:700px;overflow-y:auto;overflow-x:hidden">
            <div class="card">
                <h5 class="card-header" id="header-search" style="display:none;">Danh sách tìm kiếm</h5>

                    <ul class="list-group list-group-flush" id="ul-list-search">

                    </ul>
                
            </div>
        </div>
        <div class="col-md-2"></div>
    </div>   
</div>
<!-- ============================================================== -->
<!-- end pageheader -->
<!-- ============================================================== -->

<div class="col-xl-12 col-lg-12 col-md-12 col-sm-12 col-12">
    <div class="card">
        <div class="card-header" style="background-color:lightgray">
            <div class="row">
                <div class="col-lg-6">
                    <p>KNOWLEDGE BASE | 2 QnA pairs</p>
                </div>
                <div class="col-lg-6">
                    <a href="#" style="float:right;" data-toggle="modal" data-target="#exampleModal"><i class="fa fa-upload"></i>Import Excel</a>
                    <a href="#" style="float:right;margin-right:10px" data-toggle="modal" data-target="#exampleModal"><i class="fa fa-plus-circle"></i>Add new QnA pair</a>
                </div>
                <div class="modal fade" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true" style="display: none;">
                    <div class="modal-dialog" role="document">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="exampleModalLabel">Add QnA Marker</h5>
                                <a href="#" class="close" data-dismiss="modal" aria-label="Close">
                                    <span aria-hidden="true">×</span>
                                </a>
                            </div>
                            <div class="modal-body">
                                <form>
                                    <div class="form-group">
                                        <label for="exampleFormControlTextarea1">Question</label>
                                        <textarea class="form-control" id="exampleFormControlTextarea1" rows="3"></textarea>
                                    </div>
                                    <div class="form-group">
                                        <label for="exampleFormControlTextarea1">Answer</label>
                                        <textarea class="form-control" id="exampleFormControlTextarea1" rows="3"></textarea>
                                    </div>
                                </form>
                            </div>
                            <div class="modal-footer">
                                <a href="#" class="btn btn-primary">Save changes</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="card-body">
            <div class="table-responsive ">
                <table class="table table-striped table-bordered table-sm" id="table-data">
                    <thead>
                        <tr>
                            <th scope="col" style="width:1%"></th>
                            <th scope="col" style="width:41%">Question</th>
                            <th scope="col" style="width:58%">Answer</th>
                        </tr>
                    </thead>
                    <tbody id="table-data-training">
                       
                    </tbody>
                </table>
            </div>
            <nav class="pagination pagination_type1">
                <ol class="pagination__list" id="pagination-list">
                    <li class="pagination__group"><a href="#0" class="pagination__item pagination__control pagination__control_prev">prev</a></li>
                    <li class="pagination__group"><a href="#0" class="pagination__item">1</a></li>
                    <li class="pagination__group"><span class="pagination__item pagination__item_active">2</span></li>
                    <li class="pagination__group"><a href="#0" class="pagination__item">3</a></li>
                    <li class="pagination__group"><a href="#0" class="pagination__item pagination__control pagination__control_next">next</a></li>
                </ol>
                <div class="pagination__list m-l-20">
                    <select id="results-pp">
                        <option value="5" selected>5</option>
                        <option value="10">10</option>
                        <option value="20">20</option>
                        <option value="100">100</option>
                        <option value="All">Tất cả</option>
                    </select>
                    <span class="m-l-10">Số lượng hiển thị</span>
                </div>
                <span id="text-number-show" style="margin:10px 10px 0 auto">từ <span style="font-weight: bold">1</span> đến <span style="font-weight: bold">5 </span>trong <span style="font-weight: bold">331 </span>mục</span>
            </nav>
        </div>
    </div>
</div>
<script>
    var ismobile = navigator.userAgent.match(/(iPad)|(iPhone)|(iPod)|(android)|(webOS)/i) != null
    var touchorclick = (ismobile) ? 'touchstart' : 'click'
    var searchcontainer = document.getElementById('searchcontainer')
    var searchfield = document.getElementById('search-terms')
    var searchlabel = document.getElementById('search-label')

    searchlabel.addEventListener(touchorclick, function (e) { // when user clicks on search label
        searchcontainer.classList.toggle('opensearch') // add or remove 'opensearch' to searchcontainer
        if (!searchcontainer.classList.contains('opensearch')) { // if hiding searchcontainer
            searchfield.blur() // blur search field
            e.preventDefault() // prevent default label behavior of focusing on search field again
        }
        e.stopPropagation() // stop event from bubbling upwards
    }, false)

    searchfield.addEventListener(touchorclick, function (e) { // when user clicks on search field
        e.stopPropagation() // stop event from bubbling upwards
    }, false)

    document.addEventListener(touchorclick, function (e) { // when user clicks anywhere in document
        if (e.target.className == "close-form-search") {
            searchcontainer.classList.remove('opensearch')
            searchfield.blur()
        }

    }, false)
</script>


<script>

    $(document).ready(function () {
       // init data
        getDataTraining();

        $("#btnSearch").off().on('click', function () {
            var content = $("#search-terms").val();
            if (content.trim() == "") return false;
            else search(content);
        })

        $("#search-terms").keyup(function (e) {
            if (e.keyCode == 40 || e.keyCode == 38) {
                $(this).focusToEnd();
                return false;
            } 
            getSuggest($(this).val());
        })
    })

    function getDataTraining() {
        var param = {
            page: 1,
            pageSize: 10
        }
        param = JSON.stringify(param)
        $.ajax({
            url: _Host + 'api/GetAll',
            contentType: 'application/json; charset=utf-8',
            data: param,
            type: 'POST',
            success: function (result) {
                new renderTemplate(result).Table();
            },
        });
    }

    function getSuggest(content) {
        if (content.trim() == "") {
            $("#div-suggest").css('display', 'none');
            return false;
        }
        var param = {
            text: content,
            isAccentVN: true
        }
        param = JSON.stringify(param)
        $.ajax({
            url: _Host + 'api/Suggest',
            contentType: 'application/json; charset=utf-8',
            data: param,
            type: 'POST',
            success: function (result) {
                new renderTemplate(result).Suggest(content);
            },
        });
    }

    function search(content) {
        $("#div-suggest").css('display', 'none');
        var param = {
            text: content,
            isAccentVN: true
        }
        param = JSON.stringify(param)
        $.ajax({
            url: _Host + 'api/Search',
            contentType: 'application/json; charset=utf-8',
            data: param,
            type: 'POST',
            success: function (result) {
                new renderTemplate(result.Items).Search();
            },
        });
    }

    renderTemplate = function(data){
        this.Table = function () {
            var dataTable = data.Items;
            var html = '';
            if (dataTable.length != 0) {
                $.each(dataTable, function (index, item) {
                    index = index + 1;
                    html += '<tr>';
                    html += '<td>' + index + '</td>';
                    html += '<td>' + item.Body + '</td>';
                    html += '<td></td>';
                    html += '</tr>';
                })
            }
            $("#table-data-training").empty().append(html);


        },
        this.Suggest = function (content) {
            var html = '';
            if (data.length != 0) {
                $("#div-suggest").css('display', 'block');
                html += '<li class="sbct" jsaction="touchstart:.CLIENT;touchend:.CLIENT;touchcancel:.CLIENT;touchmove:.CLIENT;contextmenu:.CLIENT" style="display:none">';
                html += '<div class="suggestions-inner-container">';
                html += '<div class="sbtc" role="option">';
                html += '<div class="sbl1"><span>' + content + '</span></div>';
                html += '</div>';
                html += '</div>';
                html += '</li>';
                $.each(data, function (index, item) {
                    html += '<li class="sbct" jsaction="touchstart:.CLIENT;touchend:.CLIENT;touchcancel:.CLIENT;touchmove:.CLIENT;contextmenu:.CLIENT">';
                    html += '<div class="suggestions-inner-container">';
                    html += '<div class="sbtc" role="option">';
                    html += '<div class="sbl1"><span>' + item + '</span></div>';
                    html += '</div>';
                    //html += '<div class="sbab" style="display: none;"><div class="sbai">Xóa</div></div>';
                    html += '</div>';
                    html += '</li>';
                })
            } else {
                $("#div-suggest").css('display', 'none');
            }
            // append list suggest
            $("#ul-suggest").empty().append(html);

            // arrow keyup select text suggest
            var $listItems = $('li.sbct'),
                $current;
            var isFocusFirstLiHidden = true;
            $("#search-terms").keydown(function (e) {
                var key = e.keyCode,
                    $selected = $listItems.filter('.suggest-selected');

                if (key != 40 && key != 38) return;

                $listItems.removeClass('suggest-selected');
                if (document.getElementById('ul-suggest') !== null) {
                    if (key == 40) // Down key
                    {
                        if (!$selected.length || $selected.is(':last-child')) {
                            if (isFocusFirstLiHidden) {// xử lý lần đầu key up bỏ qua thẻ li đầu tiên
                                $current = $listItems.eq(1);
                                isFocusFirstLiHidden = false;
                            } else {
                                $current = $listItems.eq(0);
                            }
                        }
                        else {
                            $current = $selected.next();
                        }
                    }
                    else if (key == 38) // Up key
                    {
                        if (!$selected.length || $selected.is(':first-child')) {
                            $current = $listItems.last();
                        }
                        else {
                            $current = $selected.prev();
                        }
                    }

                    $current.addClass('suggest-selected');
                    $(this).val($current.addClass('suggest-selected').text());
                    $(this).focusToEnd();
                }
            })

            // select text suggest to search
            $(".sbtc").off().on('click', function () {
                var content = $(this).text();
                $("#div-suggest").css('display', 'none');
                $("#search-terms").val(content);
                search(content);
            })
        },
        this.Search = function () {
            $("#header-search").css('display', 'block');
            var html = '';
            if (data.length != 0) {
                $.each(data, function (index, item) {
                    html += '<li class="list-group-item"><a href="#">' + item.Body + '</a></li>';
                })
            } else {
                html += '<li class="list-group-item">Không tìm thấy</li>';
            }
            $("#ul-list-search").empty().append(html);
        }
    }

    // set cursor to end position textarea
    $.fn.focusToEnd = function () {
        return this.each(function () {
            var v = $(this).val();
            $(this).focus().val("").val(v);
        });
    };
</script>